/*
 2025 (c) Sahana Software Foundation
 @license MIT
*/
(function(a,p){var n=0;a.widget("s3.variableColumns",{options:{},_create:function(){this.id=n;n+=1;this.eventNamespace=".variableColumns";this.columnConfigs={}},_init:function(){var b=a(this.element).closest("form.dt-wrapper");this.availableColumns=b=a(".column-selector",b);this.configsURL=b.data("url");this.refresh()},_destroy:function(){this._unbindEvents()},refresh:function(){this._unbindEvents();this._bindEvents()},_openDialog:function(){const b=this.availableColumns;if(b.length){var c=a('<div class="column-select-container">').hide().appendTo(a("body")),
d=this;b.first().clone().removeClass("hide").show().appendTo(c);var e=c.show().dialog({title:i18n.selectColumns,autoOpen:!1,minHeight:480,maxHeight:640,minWidth:320,modal:!0,closeText:"",open:function(){d._bindDialogEvents(e,c);a(".column-options",c).sortable({placeholder:"sortable-placeholder",forcePlaceholderSize:!0});d._initConfigManager(c)},close:function(){d._removeDialogEvents(c);a(".column-options",c).sortable("destroy");c.hide().remove()}});e.dialog("open")}},_applyColumnSelection:function(b,
c){const d=document.createElement("a");d.href=window.location.href;const e=new URLSearchParams(d.search);e.delete("aCols");if(!c){const f=[];a(".column-select:checked",b).each(function(){f.push(a(this).data("index"))});f.length&&e.append("aCols",f.join(","))}d.search=e.toString();window.location.href=d.href},_updateColumnSelection:function(b,c){b=a("tbody.column-options",b);b=a("tr",b);const d={},e=Array.from(c.columns);var f;const h=function(g){for(f=g;e.length&&d.hasOwnProperty(e[0]);){g=e[0];let l=
d[g];l.insertAfter(f);f=l;delete d[g];e.splice(0,1)}};b.each(function(){let g=a(this),l=a("input.column-select",g),k=l.data("selector"),m=e.indexOf(k);f=g;-1==m?l.prop("checked",!1):0==m?(l.prop("checked",!0),e.splice(0,1),h(g)):(l.prop("checked",!0),g.detach(),d[k]=g)});h(f)},_initConfigManager:function(b){var c=this.configsURL;if(c){var d=a(".cfg-select-options",b),e=a(".cfg-select-throbber",b).show();a.ajaxS3({url:c,type:"GET",dataType:"json",retryLimit:0,success:function(f){f=f.configs;const h=
i18n.savedConfigurations||"Saved Configurations...";f&&f.length&&(d.empty(),a("<option>").val("").text(h).prop("disabled",!0).prop("selected",!0).appendTo(d),f.forEach(function(g){a("<option>").val(g.id).text(g.name).appendTo(d)}))},always:function(){e.hide()}});this._bindConfigManagerEvents(b)}},_loadConfig:function(b,c){const d=this.columnConfigs;if(d.hasOwnProperty(c))this._updateColumnSelection(b,d[c]);else{var e=this.configsURL;if(e){var f=a(".cfg-select-throbber",b).show(),h=this;a.ajaxS3({url:e+
"?load="+c,type:"GET",dataType:"json",retryLimit:0,success:function(g){d[g.id]=g;h._updateColumnSelection(b,g);f.hide()},always:function(){f.hide()}})}}},_deleteConfig:function(b){const c=this.configsURL;if(c){var d=a(".cfg-select-options",b),e=a("option:selected",d),f=e.val(),h=e.text().trim();if(f&&h&&confirm('Delete "'+h+'"?')){const g=a(".cfg-select-throbber",b).show(),l=this;a.ajaxS3({url:c+"?delete="+f,type:"DELETE",dataType:"json",retryLimit:0,success:function(k){d.val("");e.remove();delete l.columnConfigs[f]},
always:function(){g.hide()}})}}},_toggleConfigSave:function(b,c){const d=a(".cfg-select",b),e=a(".cfg-save",b),f=a(".cfg-select-options",b);b=a("input.cfg-save-name",b);if(c){c=a("option:selected",f);let h="",g=0;f.val()&&(h=c.text().trim(),g=2*h.length);d.hide();e.removeClass("hide").show();b.val(h).focus();b[0].setSelectionRange(g,g)}else b.val(""),e.hide(),d.removeClass("hide").show()},_saveConfig:function(b){const c=this.configsURL;if(c){var d=a("input.cfg-save-name",b).val().trim();if(d){var e=
[];a(".column-select:checked",b).each(function(){e.push(a(this).data("selector"))});if(e.length){var f=this.columnConfigs,h=a(".cfg-select-options",b),g=a(".cfg-select-throbber",b).show(),l=this;a.ajaxS3({url:c,type:"POST",data:JSON.stringify({name:d,columns:e}),dataType:"json",retryLimit:0,success:function(k){if(k=k.updated||k.created){f[k]={columns:e,id:k,name:d};var m=a('option[value="'+k+'"]',h);m.length?m.prop("selected",!0):a("<option>").val(k).text(d).appendTo(h).prop("selected",!0);h.val(k)}},
always:function(){g.hide();l._toggleConfigSave(b,!1)}})}}}},_bindDialogEvents:function(b,c){const d=this.eventNamespace,e=this;a(".ui-widget-overlay").off(d).on("click"+d,function(){b.dialog("close")});a(".cancel-form-btn",c).off(d).on("click"+d,function(){b.dialog("close")});a(".submit-form-btn",c).off(d).on("click"+d,function(){a(".column-select:checked",c).length&&(e._applyColumnSelection(c),b.dialog("close"))});a(".reset-form-btn",c).off(d).on("click"+d,function(){e._applyColumnSelection(c,!0)});
a(".column-left",c).off(d).on("click"+d,function(){a(this).closest("tr").insertBefore(row.prev())});a(".column-right",c).off(d).on("click"+d,function(){a(this).closest("tr").insertAfter(row.next())});a(".column-select-all",c).off(d).on("change"+d,function(){let f=a(this).prop("checked");a(".column-select",c).prop("checked",f)});a(".column-select",c).off(d).on("change"+d,function(){let f=a(".column-select:not(:checked)",c).length;a(".column-select-all",c).prop("checked",!f)})},_bindConfigManagerEvents:function(b){const c=
this.eventNamespace,d=this;a(".cfg-select-options",b).off(c).on("change"+c,function(){let e=a(this).val();e&&d._loadConfig(b,e-0)});a(".cfg-select-save",b).off(c).on("click"+c,function(){d._toggleConfigSave(b,!0)});a(".cfg-select-delete",b).off(c).on("click"+c,function(){d._deleteConfig(b)});a(".cfg-save-name",b).off(c).on("keyup"+c,function(e){e.preventDefault();e.stopPropagation();switch(e.which){case 13:d._saveConfig(b);break;case 27:d.toogleConfigSave(b,!1)}});a(".cfg-save-submit",b).off(c).on("click"+
c,function(){d._saveConfig(b)});a(".cfg-save-cancel",b).off(c).on("click"+c,function(){d._toggleConfigSave(b,!1)})},_removeDialogEvents:function(b){const c=this.eventNamespace;a(".ui-widget-overlay").off(c);a(".cancel-form-btn, .submit-form-btn, .reset-form-button",b).off(c);a(".column-left, .column-right",b).off(c);a(".column-select, .column-select-all",b).off(c);a(".cfg-select-options, .cfg-select-save, .cfg-select-delete",b).off(c);a(".cfg-save-name, .cfg-save-submit, .cfg-save-cancel",b).off(c)},
_bindEvents:function(){const b=this,c=this.eventNamespace;a(this.element).on("click"+c,function(){b._openDialog()});return!0},_unbindEvents:function(){const b=this.eventNamespace;this._removeDialogEvents(a(".column-select-container"));a(this.element).off(b);return!0}})})(jQuery);
