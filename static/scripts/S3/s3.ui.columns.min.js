/*
 2025 (c) Sahana Software Foundation
 @license MIT
*/
(function(a,q){var n=0;a.widget("s3.variableColumns",{options:{},_create:function(){this.id=n;n+=1;this.eventNamespace=".variableColumns";this.columnConfigs={}},_init:function(){var c=a(this.element).closest("form.dt-wrapper");this.availableColumns=c=a(".column-selector",c);this.configsURL=c.data("url");this.refresh()},_destroy:function(){this._unbindEvents()},refresh:function(){this._unbindEvents();this._bindEvents()},_openDialog:function(){const c=this.availableColumns;if(c.length){var b=a('<div class="column-select-container">').hide().appendTo(a("body")),
d=this;c.first().clone().removeClass("hide").show().appendTo(b);var f=b.show().dialog({title:i18n.selectColumns,autoOpen:!1,minHeight:480,maxHeight:640,minWidth:320,modal:!0,closeText:"",open:function(){d._bindDialogEvents(f,b);a(".column-options",b).sortable({placeholder:"sortable-placeholder",forcePlaceholderSize:!0});d._initConfigManager(b)},close:function(){d._removeDialogEvents(b);a(".column-options",b).sortable("destroy");b.hide().remove()}});f.dialog("open")}},_applyColumnSelection:function(c,
b){const d=document.createElement("a");d.href=window.location.href;const f=new URLSearchParams(d.search);f.delete("aCols");if(!b){const e=[];a(".column-select:checked",c).each(function(){e.push(a(this).data("index"))});e.length&&f.append("aCols",e.join(","))}d.search=f.toString();window.location.href=d.href},_updateColumnSelection:function(c,b){var d=a("tbody.column-options",c);d=a("tr",d);const f={},e=Array.from(b.columns);var g;const k=function(l){for(g=l;e.length&&f.hasOwnProperty(e[0]);){l=e[0];
let h=f[l];h.insertAfter(g);g=h;delete f[l];e.splice(0,1)}};d.each(function(){let l=a(this),h=a("input.column-select",l),m=h.data("selector"),p=e.indexOf(m);g=l;-1==p?h.prop("checked",!1):0==p?(h.prop("checked",!0),e.splice(0,1),k(l)):(h.prop("checked",!0),l.detach(),f[m]=l)});k(g);b=a(".column-select:not(:checked)",c).length;a(".column-select-all",c).prop("checked",!b)},_initConfigManager:function(c){var b=this.configsURL;if(b){var d=a(".cfg-select-options",c),f=a(".cfg-select-throbber",c).show();
a.ajaxS3({url:b,type:"GET",dataType:"json",retryLimit:0,success:function(e){e=e.configs;const g=i18n.savedConfigurations||"Saved Configurations...";e&&e.length&&(d.empty(),a("<option>").val("").text(g).prop("disabled",!0).prop("selected",!0).appendTo(d),e.forEach(function(k){a("<option>").val(k.id).text(k.name).appendTo(d)}))},always:function(){f.hide()}});this._bindConfigManagerEvents(c)}},_loadConfig:function(c,b){const d=this.columnConfigs;if(d.hasOwnProperty(b))this._updateColumnSelection(c,d[b]);
else{var f=this.configsURL;if(f){var e=a(".cfg-select-throbber",c).show(),g=this;a.ajaxS3({url:f+"?load="+b,type:"GET",dataType:"json",retryLimit:0,success:function(k){d[k.id]=k;g._updateColumnSelection(c,k);e.hide()},always:function(){e.hide()}})}}},_deleteConfig:function(c){const b=this.configsURL;if(b){var d=a(".cfg-select-options",c),f=a("option:selected",d),e=f.val(),g=f.text().trim();if(e&&g&&confirm('Delete "'+g+'"?')){const k=a(".cfg-select-throbber",c).show(),l=this;a.ajaxS3({url:b+"?delete="+
e,type:"DELETE",dataType:"json",retryLimit:0,success:function(h){d.val("");f.remove();delete l.columnConfigs[e]},always:function(){k.hide()}})}}},_toggleConfigSave:function(c,b){const d=a(".cfg-select",c),f=a(".cfg-save",c),e=a(".cfg-select-options",c);c=a("input.cfg-save-name",c);if(b){b=a("option:selected",e);let g="",k=0;e.val()&&(g=b.text().trim(),k=2*g.length);d.hide();f.removeClass("hide").show();c.val(g).focus();c[0].setSelectionRange(k,k)}else c.val(""),f.hide(),d.removeClass("hide").show()},
_saveConfig:function(c){const b=this.configsURL;if(b){var d=a("input.cfg-save-name",c).val().trim();if(d){var f=[];a(".column-select:checked",c).each(function(){f.push(a(this).data("selector"))});if(f.length){var e=this.columnConfigs,g=a(".cfg-select-options",c),k=a(".cfg-select-throbber",c).show(),l=this;a.ajaxS3({url:b,type:"POST",data:JSON.stringify({name:d,columns:f}),dataType:"json",retryLimit:0,success:function(h){if(h=h.updated||h.created){e[h]={columns:f,id:h,name:d};var m=a('option[value="'+
h+'"]',g);m.length?m.prop("selected",!0):a("<option>").val(h).text(d).appendTo(g).prop("selected",!0);g.val(h)}},always:function(){k.hide();l._toggleConfigSave(c,!1)}})}}}},_bindDialogEvents:function(c,b){const d=this.eventNamespace,f=this;a(".ui-widget-overlay").off(d).on("click"+d,function(){c.dialog("close")});a(".cancel-form-btn",b).off(d).on("click"+d,function(){c.dialog("close")});a(".submit-form-btn",b).off(d).on("click"+d,function(){a(".column-select:checked",b).length&&(f._applyColumnSelection(b),
c.dialog("close"))});a(".reset-form-btn",b).off(d).on("click"+d,function(){f._applyColumnSelection(b,!0)});a(".column-left",b).off(d).on("click"+d,function(){let e=a(this).closest("tr");e.insertBefore(e.prev())});a(".column-right",b).off(d).on("click"+d,function(){let e=a(this).closest("tr");e.insertAfter(e.next())});a(".column-select-all",b).off(d).on("change"+d,function(){let e=a(this).prop("checked");a(".column-select",b).prop("checked",e)});a(".column-select",b).off(d).on("change"+d,function(){let e=
a(".column-select:not(:checked)",b).length;a(".column-select-all",b).prop("checked",!e)})},_bindConfigManagerEvents:function(c){const b=this.eventNamespace,d=this,f=function(){let e=a(this).val();e&&d._loadConfig(c,e-0)};a(".cfg-select-options",c).off(b).on("change"+b,f);a(".cfg-select-options",c).off(b).on("click"+b,"option",f);a(".cfg-select-save",c).off(b).on("click"+b,function(){d._toggleConfigSave(c,!0)});a(".cfg-select-delete",c).off(b).on("click"+b,function(){d._deleteConfig(c)});a(".cfg-save-name",
c).off(b).on("keyup"+b,function(e){e.preventDefault();e.stopPropagation();switch(e.which){case 13:d._saveConfig(c);break;case 27:d.toogleConfigSave(c,!1)}});a(".cfg-save-submit",c).off(b).on("click"+b,function(){d._saveConfig(c)});a(".cfg-save-cancel",c).off(b).on("click"+b,function(){d._toggleConfigSave(c,!1)})},_removeDialogEvents:function(c){const b=this.eventNamespace;a(".ui-widget-overlay").off(b);a(".cancel-form-btn, .submit-form-btn, .reset-form-button",c).off(b);a(".column-left, .column-right",
c).off(b);a(".column-select, .column-select-all",c).off(b);a(".cfg-select-options, .cfg-select-save, .cfg-select-delete",c).off(b);a(".cfg-save-name, .cfg-save-submit, .cfg-save-cancel",c).off(b)},_bindEvents:function(){const c=this,b=this.eventNamespace;a(this.element).on("click"+b,function(){c._openDialog()});return!0},_unbindEvents:function(){const c=this.eventNamespace;this._removeDialogEvents(a(".column-select-container"));a(this.element).off(c);return!0}})})(jQuery);
